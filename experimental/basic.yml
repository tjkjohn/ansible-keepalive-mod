- name: Modify AWS  instances
  hosts: 54.179.181.16
  become: yes
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.pems/key-aws-maas-staging.pem
  tasks:
    - name: Get ownership before update
      stat:
        path: /etc/sensu/conf.d/client.json
      register: st_before

    - name: Actual attempt to change the threshold values
      ghetto_json:
        path=/etc/sensu/conf.d/client.json
        client.keepalive.thresholds.warning=150
        client.keepalive.thresholds.critical=180

    - name: Get ownership after update
      stat:
        path: /etc/sensu/conf.d/client.json
      register: st_after

    - name: Check if file ownership has changed
      fail:
        msg: "Yikes, file ownership has changed!"
      when: st_before.stat.pw_name != st_after.stat.pw_name

    - name: Restart sensu-client
      command: echo "Restarting sensu-client service"
      notify: "restart services"

    - service_facts:
      command: echo "Get service state"
      register: service_state

    - name: Check if service restart is successful
      fail:
        msg: "Sensu-client failed to restart!"
      when: service_state.changed != true
  
  handlers: 
    - name: restart sensu-client 
      service: 
        name: sensu-client 
        state: restarted
      listen: "restart services"

